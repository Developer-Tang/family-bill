# 墨唐家庭记账（FamilyBill）部署手册

## 1. 部署概述

墨唐家庭记账（FamilyBill）采用轻量化Docker容器化部署方案，默认使用SQLite单文件数据库，实现真正的"一键部署"体验。本手册重点介绍简单高效的部署方法，优先推荐SQLite模式，同时提供MySQL选项（仅针对有特殊需求的用户）。

## 2. 部署前准备

### 2.1 环境要求

#### 2.1.1 硬件要求

| 部署规模 | CPU | 内存 | 存储空间 | 适用场景 |
|---------|-----|------|---------|----------|
| 轻量部署 | 1核 | 1GB | 5GB | 个人使用，2-5人小家庭（推荐） |
| 标准部署 | 2核 | 2GB | 10GB | 多成员家庭（5人以上） |

#### 2.1.2 软件要求

- **Docker**: 20.10.0+ （必需）
- **操作系统**: 
  - Linux: 任意支持Docker的发行版
  - Windows: Windows 10/11（启用WSL2）
  - macOS: 任意支持Docker的版本
- **网络**: 确保可访问互联网（拉取镜像）

### 2.2 网络准备

- **端口映射**: 默认使用8080端口（可自定义）
- **防火墙**: 确保映射的端口已在防火墙中开放

### 2.3 数据库准备

墨唐家庭记账优先推荐SQLite模式，无需额外配置：

#### 2.3.1 SQLite模式（默认，强烈推荐）
- 无需单独安装数据库
- 数据存储在单个文件中
- 备份极其简单（只需复制一个文件）
- 对于90%的家庭用户完全足够

#### 2.3.2 MySQL模式（可选，仅针对特殊需求）
- 仅当您有5人以上同时高频使用时才考虑
- 需要单独部署MySQL 8.0+
- 配置相对复杂（本节末尾提供）

## 3. 部署步骤

### 3.1 快速部署（SQLite模式）【推荐】

SQLite模式是最简单的部署方式，适合90%的用户场景，只需一个命令即可完成：

```bash
# 创建数据存储目录（用于持久化SQLite数据库文件）
mkdir -p ~/family_bill/data

# 启动容器（SQLite模式）
docker run -d \
  --name family_bill \
  -p 8080:8080 \
  -v ~/family_bill/data:/app/data \
  -e SECRET_KEY=your_secret_key_here \
  --restart unless-stopped \
  familybill/app:latest
```

参数说明：
- `-p 8080:8080`: 将容器的8080端口映射到主机
- `-v ~/family_bill/data:/app/data`: 持久化存储SQLite数据库文件（非常重要）
- `-e SECRET_KEY=your_secret_key_here`: 设置一个自定义的密钥（请修改为任意复杂字符串）
- `--restart unless-stopped`: 容器意外停止时自动重启

**部署完成！** 现在可以通过 http://您的IP:8080 访问系统了。

> 提示：Windows用户可以在任意位置创建family_bill/data文件夹，然后将命令中的`~/family_bill/data`替换为对应路径，如`D:\family_bill\data`

### 3.2 MySQL模式部署（可选）

**注意：仅当您有5人以上同时高频使用时才需要考虑MySQL模式**

#### 3.2.1 准备MySQL数据库

```bash
# 登录MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE family_bill DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户并授权
CREATE USER 'family_bill'@'%' IDENTIFIED BY 'your_strong_password';
GRANT ALL PRIVILEGES ON family_bill.* TO 'family_bill'@'%';
FLUSH PRIVILEGES;
```

#### 3.2.2 启动容器（MySQL模式）

```bash
# 启动容器（MySQL模式）
docker run -d \
  --name family_bill \
  -p 8080:8080 \
  -e DB_TYPE=mysql \
  -e DB_HOST=your_mysql_host \
  -e DB_PORT=3306 \
  -e DB_USER=family_bill \
  -e DB_PASSWORD=your_strong_password \
  -e DB_NAME=family_bill \
  -e SECRET_KEY=your_secret_key_here \
  --restart unless-stopped \
  familybill/app:latest
```

## 4. 核心环境变量配置

墨唐家庭记账采用简化的配置方式，以下是最常用的环境变量：

| 环境变量 | 默认值 | 说明 | 是否必填 |
|---------|--------|------|----------|
| `SECRET_KEY` | - | 应用密钥，用于数据加密，请务必设置 | 是 |
| `DB_TYPE` | sqlite | 数据库类型（sqlite/mysql） | 否 |
| `DB_HOST` | localhost | MySQL主机地址（仅MySQL模式） | MySQL模式必填 |
| `DB_PORT` | 3306 | MySQL端口（仅MySQL模式） | MySQL模式必填 |
| `DB_USER` | - | MySQL用户名（仅MySQL模式） | MySQL模式必填 |
| `DB_PASSWORD` | - | MySQL密码（仅MySQL模式） | MySQL模式必填 |
| `DB_NAME` | family_bill | 数据库名称（仅MySQL模式） | MySQL模式必填 |

> 提示：对于99%的用户，只需要设置`SECRET_KEY`这一个环境变量即可

## 5. 部署后配置

### 5.1 首次访问

部署完成后，直接访问：
- **Web端**: http://您的IP:8080
- **移动端**: 用手机浏览器访问相同地址

### 5.2 初始设置

首次访问时，系统会引导您完成简单的初始设置：
1. **创建管理员账户**
2. **创建家庭组名称**
3. **设置默认账本**

### 5.3 数据备份（重要！）

SQLite模式的备份非常简单，只需要复制数据库文件：

```bash
# 手动备份（推荐定期执行）
cp ~/family_bill/data/family_bill.db ~/family_bill/data/backup_$(date +%Y%m%d).db
```

**Windows用户**可以直接复制 `family_bill/data/` 目录下的 `family_bill.db` 文件到安全位置。

> 提示：建议每周至少手动备份一次数据库文件到U盘或云盘

## 6. 日常维护

### 6.1 基本容器管理

```bash
# 查看容器状态
docker ps -a | grep family_bill

# 查看应用日志
docker logs family_bill

# 重启应用
docker restart family_bill

# 停止应用
docker stop family_bill

# 启动应用
docker start family_bill
```

### 6.2 升级应用

```bash
# 1. 先备份数据（非常重要！）
cp ~/family_bill/data/family_bill.db ~/family_bill/data/family_bill_backup_$(date +%Y%m%d).db

# 2. 拉取最新镜像
docker pull familybill/app:latest

# 3. 停止并删除旧容器
docker stop family_bill
docker rm family_bill

# 4. 重新启动容器（使用之前的部署命令）
docker run -d \
  --name family_bill \
  -p 8080:8080 \
  -v ~/family_bill/data:/app/data \
  -e SECRET_KEY=your_secret_key_here \
  --restart unless-stopped \
  familybill/app:latest
```

## 7. 常见问题与故障排除

### 7.1 容器启动失败

**现象**: 容器启动后立即退出

**排查步骤**:
1. 查看容器日志: `docker logs family_bill`
2. 检查`SECRET_KEY`是否正确设置
3. 确保映射的端口未被占用
4. 检查数据卷权限: 确保挂载目录有正确的读写权限

### 7.2 无法访问系统

**排查步骤**:
1. 确认容器正在运行: `docker ps | grep family_bill`
2. 检查防火墙是否开放了8080端口
3. 确认服务器IP地址正确

## 8. 部署文档总结

墨唐家庭记账（FamilyBill）采用极致简化的部署方案，让记账变得简单：

1. **轻量级设计**: 默认SQLite数据库，单文件存储，资源占用极低
2. **一键部署**: 一条命令即可完成部署，无需复杂配置
3. **简单备份**: 只需复制一个文件即可完成数据备份
4. **稳定可靠**: 精简的架构确保系统稳定运行，适合长期使用

通过本部署手册，您可以在几分钟内完成墨唐家庭记账系统的部署，开始享受简单高效的家庭财务管理体验。